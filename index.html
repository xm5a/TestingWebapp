<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>OpenLayers Geofence Color Coding Example</title>
  <script src="https://unpkg.com/ol/dist/ol.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/ol/ol.css">
  <script src="https://unpkg.com/ol-mapbox-style/dist/olms.js"></script>
  <style>
    html, body { width: 100%; height: 100%; margin: 0; padding: 0; }
    #map { width: 100%; height: 90vh; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    // Map setup
    const openfreemap = new ol.layer.Group();
    const initialCenter = ol.proj.fromLonLat([13.388, 52.517]);
    const map = new ol.Map({
      layers: [openfreemap],
      view: new ol.View({center: initialCenter, zoom: 15}),
      target: 'map'
    });
    olms.apply(openfreemap, 'https://tiles.openfreemap.org/styles/liberty');

    // Marker setup (uses built-in style)
    const marker = new ol.Feature(new ol.geom.Point(initialCenter));
    marker.setStyle(new ol.style.Style({
      image: new ol.style.Circle({
        radius: 10,
        fill: new ol.style.Fill({color: 'blue'}),
        stroke: new ol.style.Stroke({color: 'white', width: 2})
      })
    }));
    const markerLayer = new ol.layer.Vector({
      source: new ol.source.Vector({features: [marker]})
    });
    map.addLayer(markerLayer);

    // Geofence setup
    const geofenceCenter = initialCenter;
    const geofenceRadius = 500; // meters

    function getGeofenceStyle(inside) {
      return new ol.style.Style({
        stroke: new ol.style.Stroke({
          color: inside ? 'green' : 'red',
          width: 3
        }),
        fill: new ol.style.Fill({
          color: inside ? 'rgba(0,255,0,0.3)' : 'rgba(255,0,0,0.3)'
        })
      });
    }

    const geofenceFeature = new ol.Feature(new ol.geom.Circle(geofenceCenter, geofenceRadius));
    let isInside = false;
    geofenceFeature.setStyle(getGeofenceStyle(isInside));
    const geofenceLayer = new ol.layer.Vector({
      source: new ol.source.Vector({features: [geofenceFeature]})
    });
    map.addLayer(geofenceLayer);

    // Geofencing logic
    let wasInsideGeofence = false;
    navigator.geolocation.watchPosition((position) => {
      const lon = position.coords.longitude;
      const lat = position.coords.latitude;
      const userLocation = ol.proj.fromLonLat([lon, lat]);
      marker.getGeometry().setCoordinates(userLocation);
      map.getView().setCenter(userLocation);

      const circle = geofenceFeature.getGeometry();
      const distance = ol.sphere.getDistance(
        ol.proj.toLonLat(circle.getCenter()),
        [lon, lat]
      );
      const inside = distance <= circle.getRadius();

      if (inside !== isInside) {
        geofenceFeature.setStyle(getGeofenceStyle(inside));
        isInside = inside;
      }
      if (inside && !wasInsideGeofence) {
        alert('You have entered the geofenced area!');
      } else if (!inside && wasInsideGeofence) {
        alert('You have exited the geofenced area!');
      }
      wasInsideGeofence = inside;
    }, (error) => {
      console.error('Geolocation error:', error.message);
      alert('Unable to access your location. Please enable GPS or location services.');
    });
  </script>
</body>
</html>
